<!DOCTYPE html>
<html lang="ru">
  <style>
  .mw-panel{display:flex;gap:12px;align-items:center;justify-content:center;flex-wrap:wrap;margin:10px 0 12px}
  .mw-panel select{padding:6px 10px;border:1px solid #dad7ee;border-radius:10px;background:#fff}
  .mw-sound{display:flex;gap:6px;align-items:center;background:#fff;border:1px solid #e8e6f2;border-radius:10px;padding:6px 8px}
  .mw-emoji{dominant-baseline:middle;text-anchor:middle;filter:drop-shadow(0 2px 2px rgba(0,0,0,.18));pointer-events:none}
</style>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Soroban ‚Äî —Å—Ç–∏–ª—å + –∑–≤—É–∫ (—Ä–æ–≤–Ω–∞—è –≤–µ—Ä—Å—Ç–∫–∞)</title>
<style>
  :root{--bg:#F4F5FB;--wood:#8B5A2B;--rod:#7A5533;--text:#4a3b2f;--bead:#F39A32;--bead-edge:#D07416}
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  h1{margin:8px 0 14px;font-size:22px;color:var(--wood);text-align:center}
  .panel{display:flex;gap:12px;justify-content:center;align-items:center;flex-wrap:wrap;margin:8px 0 12px}
  select{padding:8px 10px;border:1px solid #dad7ee;border-radius:10px;background:#fff}
  .sound{display:flex;gap:6px;align-items:center;background:#fff;border:1px solid #e8e6f2;border-radius:10px;padding:6px 8px}
  .board{position:relative;width:100%;aspect-ratio:16/6;background:#f7f6fb;border-radius:24px;box-shadow:0 8px 24px rgba(0,0,0,.12)}
  svg{position:absolute;inset:0;width:100%;height:100%;display:block}
  /* —Ä–∞–º–∞ */
  .rail{fill:var(--wood);filter:drop-shadow(0 4px 8px rgba(0,0,0,.25))}
  .beam{fill:var(--wood);filter:drop-shadow(0 3px 6px rgba(0,0,0,.22))}
  /* —Å–ø–∏—Ü—ã */
  .rod{stroke:var(--rod);stroke-width:12;stroke-linecap:round}
  /* –±—É—Å–∏–Ω—ã */
  .bead{cursor:pointer;touch-action:manipulation}
  .oval{fill:var(--bead);stroke:var(--bead-edge);stroke-width:3;filter:drop-shadow(0 3px 4px rgba(0,0,0,.25))}
  .emoji{dominant-baseline:middle;text-anchor:middle;filter:drop-shadow(0 2px 2px rgba(0,0,0,.18))}
  .hint{font-size:12px;text-align:center;opacity:.75;margin-top:10px}
</style>
</head>
  <script>
(function(){
  var svg = document.querySelector('svg');
  if(!svg){ console.warn('SVG –Ω–µ –Ω–∞–π–¥–µ–Ω'); return; }

  var beadNodes = Array.from(svg.querySelectorAll('ellipse, circle'));
  var emojiLayer = document.createElementNS('http://www.w3.org/2000/svg','g');
  svg.appendChild(emojiLayer);

  var overlays=[];
  beadNodes.forEach(function(base){
    var cx=+(base.getAttribute('cx')||0), cy=+(base.getAttribute('cy')||0);
    var ry=+(base.getAttribute('ry')||base.getAttribute('r')||18);
    var fs=ry*1.6;
    var t=document.createElementNS('http://www.w3.org/2000/svg','text');
    t.setAttribute('x',cx); t.setAttribute('y',cy+1);
    t.setAttribute('class','mw-emoji');
    t.style.fontSize=fs+'px';
    t.textContent='üçì';
    t.style.display='none';
    emojiLayer.appendChild(t);
    overlays.push({text:t,baseEl:base});
  });

  var sel=document.getElementById('mw-style');
  var soundChk=document.getElementById('mw-sound');

  function applyStyle(){
    var v=sel.value;
    overlays.forEach(function(o){
      if(v==='classic'){ o.baseEl.style.visibility='visible'; o.text.style.display='none'; }
      else { o.baseEl.style.visibility='hidden'; o.text.style.display='block'; o.text.textContent=v; }
    });
  }
  sel.addEventListener('change',applyStyle);

  var ac=null;
  function clickSound(){
    if(!soundChk.checked) return;
    if(!ac) ac=new (window.AudioContext||window.webkitAudioContext)();
    var o=ac.createOscillator(), g=ac.createGain();
    o.type='square'; o.frequency.value=880; g.gain.value=0.05;
    o.connect(g); g.connect(ac.destination);
    o.start(); setTimeout(()=>o.stop(),28);
  }
  svg.addEventListener('click',function(ev){
    if(ev.target.tagName==='ellipse'||ev.target.tagName==='circle') clickSound();
  });

  applyStyle();
})();
</script>
<script>
/*
  MindWorld: –∞–∫–∫—É—Ä–∞—Ç–Ω—ã–π –ø–∞—Ç—á –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≥–µ–æ–º–µ—Ç—Ä–∏–∏.
  - –ù–∞—Ö–æ–¥–∏—Ç —Ä–µ–∞–ª—å–Ω—ã–µ –±—É—Å–∏–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (–ø–æ —Ä–∞–∑–º–µ—Ä–∞–º).
  - –°–æ–∑–¥–∞—ë—Ç –ø–æ–≤–µ—Ä—Ö —Å–ª–æ–π —Å —ç–º–æ–¥–∑–∏ —Ç–µ—Ö –∂–µ cx/cy.
  - –î–µ–ª–∞–µ—Ç clipPath –ø–æ –æ–±–ª–∞—Å—Ç–∏ –≤—Å–µ—Ö –±—É—Å–∏–Ω (—ç–º–æ–¥–∑–∏ –Ω–µ –≤—ã–ª–µ–∑–∞—é—Ç –∑–∞ —Ä–∞–º—É).
  - –ü–∞–Ω–µ–ª—å: —Å–µ–ª–µ–∫—Ç–æ—Ä #mw-style, —á–µ–∫–±–æ–∫—Å #mw-sound.
*/
(function(){
  const svg = document.querySelector('svg');
  if(!svg) return;

  // 1) –°—ã—Ä—ã–µ –∫–∞–Ω–¥–∏–¥–∞—Ç—ã: –≤—Å–µ ellipse/circle
  let raw = Array.from(svg.querySelectorAll('ellipse, circle'));

  if(raw.length === 0) return;

  // 2) –í—ã—á–∏—Å–ª–∏–º —Ç–∏–ø–∏—á–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã –±—É—Å–∏–Ω –ø–æ ry/r (—á—Ç–æ–±—ã –æ—Ç—Å–µ—è—Ç—å —É–≥–ª—ã –∏ –¥–µ–∫–æ—Ä)
  const sizes = raw.map(el => +(
    el.getAttribute('ry') || el.getAttribute('r') || 0
  ));
  // –ù–∞–π–¥—ë–º "–º–æ–¥—É" (—Å–∞–º–æ–µ —á–∞—Å—Ç–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ) —Å—Ä–µ–¥–∏ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã—Ö
  const hist = {};
  for (const s of sizes) { if (s>0) hist[Math.round(s)] = (hist[Math.round(s)]||0)+1; }
  const mode = +Object.keys(hist).reduce((a,b)=> hist[a]>hist[b]?a:b);

  // –û—Å—Ç–∞–≤–∏–º –±—É—Å–∏–Ω—ã —Å ry/r —Ä—è–¥–æ–º —Å –º–æ–¥–æ–π (¬±20%)
  const beads = raw.filter(el=>{
    const r = +(el.getAttribute('ry') || el.getAttribute('r') || 0);
    return r>0 && Math.abs(r-mode) <= mode*0.2;
  });

  if (beads.length < 5) return; // –ø–æ–¥—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞

  // 3) –ü–æ—Å—Ç—Ä–æ–∏–º –∫–ª–∏–ø –ø–æ bbox –±—É—Å–∏–Ω (+–Ω–µ–º–Ω–æ–≥–æ –ø–æ–ª–µ–π)
  let minX=Infinity, minY=Infinity, maxX=-Infinity, maxY=-Infinity, avgR=0;
  beads.forEach(el=>{
    const cx=+el.getAttribute('cx')||0, cy=+el.getAttribute('cy')||0;
    const rx=+el.getAttribute('rx')||(+el.getAttribute('r')||0);
    const ry=+el.getAttribute('ry')||(+el.getAttribute('r')||0);
    minX = Math.min(minX, cx - rx);
    maxX = Math.max(maxX, cx + rx);
    minY = Math.min(minY, cy - ry);
    maxY = Math.max(maxY, cy + ry);
    avgR += ry||rx;
  });
  avgR /= beads.length;
  const pad = Math.max(8, Math.round(avgR*0.35)); // –Ω–µ–±–æ–ª—å—à–æ–µ –ø–æ–ª–µ

  const defs = svg.querySelector('defs') || svg.insertBefore(document.createElementNS('http://www.w3.org/2000/svg','defs'), svg.firstChild);
  const clip = document.createElementNS('http://www.w3.org/2000/svg','clipPath');
  const clipId = 'mw-clip-' + Math.random().toString(36).slice(2);
  clip.setAttribute('id', clipId);
  const r = document.createElementNS('http://www.w3.org/2000/svg','rect');
  r.setAttribute('x', minX - pad);
  r.setAttribute('y', minY - pad);
  r.setAttribute('width', (maxX-minX) + pad*2);
  r.setAttribute('height', (maxY-minY) + pad*2);
  defs.appendChild(clip);
  clip.appendChild(r);

  // 4) –°–ª–æ–π –¥–ª—è —ç–º–æ–¥–∑–∏
  const emojiLayer = document.createElementNS('http://www.w3.org/2000/svg','g');
  emojiLayer.setAttribute('clip-path', 'url(#'+clipId+')');
  svg.appendChild(emojiLayer);

  // 5) –°–æ–∑–¥–∞–¥–∏–º "–Ω–∞–∫–ª–∞–¥–∫–∏" –¥–ª—è –∫–∞–∂–¥–æ–π –±—É—Å–∏–Ω—ã
  const overlays = beads.map(base=>{
    const cx=+(base.getAttribute('cx')||0), cy=+(base.getAttribute('cy')||0);
    const ry=+(base.getAttribute('ry')||base.getAttribute('r')||18);
    const fs = ry * 1.45; // —Ä–∞–∑–º–µ—Ä —ç–º–æ–¥–∑–∏ (—á—É—Ç—å –º–µ–Ω—å—à–µ –±—É—Å–∏–Ω—ã)
    const t=document.createElementNS('http://www.w3.org/2000/svg','text');
    t.setAttribute('x', cx);
    t.setAttribute('y', cy + 0.5); // –º–∏–∫—Ä–æ-—Å–º–µ—â–µ–Ω–∏–µ –¥–ª—è –æ–ø—Ç–∏–∫–∏
    t.setAttribute('class','mw-emoji');
    t.style.fontSize = fs + 'px';
    t.textContent = 'üçì';
    t.style.display = 'none';
    emojiLayer.appendChild(t);
    return {text:t, baseEl:base};
  });

  // 6) –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Å—Ç–∏–ª—è
  const sel = document.getElementById('mw-style');
  const soundChk = document.getElementById('mw-sound');

  try{
    const saved = localStorage.getItem('mwSorobanStyle');
    if(saved) sel.value = saved;
  }catch(e){}

  function applyStyle(){
    const v = sel.value;
    try{ localStorage.setItem('mwSorobanStyle', v); }catch(e){}
    for (const o of overlays) {
      if (v === 'classic') {
        o.baseEl.style.visibility = 'visible';
        o.text.style.display = 'none';
      } else {
        o.baseEl.style.visibility = 'hidden';
        o.text.style.display = 'block';
        o.text.textContent = v;
      }
    }
  }
  sel.addEventListener('change', applyStyle);

  // 7) –ó–≤—É–∫ –∫–ª–∏–∫–∞ (–Ω–µ –≤–º–µ—à–∏–≤–∞–µ–º—Å—è –≤ –ª–æ–≥–∏–∫—É –∞–±–∞–∫—É—Å–∞)
  let ac = null;
  function clickSound(){
    if(!soundChk || !soundChk.checked) return;
    try{
      if(!ac) ac = new (window.AudioContext||window.webkitAudioContext)();
      const o = ac.createOscillator(), g = ac.createGain();
      o.type='square'; o.frequency.value=880; g.gain.value=0.05;
      o.connect(g); g.connect(ac.destination); o.start(); setTimeout(()=>o.stop(),28);
    }catch(e){}
  }
  svg.addEventListener('click', (ev)=>{
    const tag = ev.target.tagName;
    if(tag==='ellipse' || tag==='circle') clickSound();
  }, false);

  // 8) –ü—Ä–∏–º–µ–Ω—è–µ–º –∏–∑–Ω–∞—á–∞–ª—å–Ω—ã–π —Å—Ç–∏–ª—å
  applyStyle();
})();
</script>

<body>
  <div class="mw-panel" id="mw-panel" role="group" aria-label="–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–±–∞–∫—É—Å–∞">
  <label>–°—Ç–∏–ª—å:
    <select id="mw-style">
      <option value="classic" selected>–ë—É—Å–∏–Ω—ã</option>
      <option value="üçì">üçì –ö–ª—É–±–Ω–∏–∫–∞</option>
      <option value="üßÅ">üßÅ –ü–∏—Ä–æ–∂–Ω–æ–µ</option>
      <option value="üçî">üçî –ë—É—Ä–≥–µ—Ä</option>
      <option value="üçé">üçé –Ø–±–ª–æ–∫–æ</option>
    </select>
  </label>
  <label class="mw-sound"><input id="mw-sound" type="checkbox" checked> –ó–≤—É–∫</label>
</div>

<div class="wrap">
  <h1>Soroban (–∫–ª–∞—Å—Å–∏–∫–∞) ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω—ã —Å—Ç–∏–ª—å –∏ –∑–≤—É–∫</h1>

  <div class="panel">
    <label>–°—Ç–∏–ª—å:
      <select id="styleSelect" aria-label="–°—Ç–∏–ª—å –±—É—Å–∏–Ω">
        <option value="classic" selected>–ë—É—Å–∏–Ω—ã</option>
        <option value="üçì">üçì –ö–ª—É–±–Ω–∏–∫–∞</option>
        <option value="‚öΩ">‚öΩ –ú—è—á</option>
        <option value="üçé">üçé –Ø–±–ª–æ–∫–æ</option>
        <option value="üßÅ">üßÅ –ü–∏—Ä–æ–∂–Ω–æ–µ</option>
        <option value="üçî">üçî –ë—É—Ä–≥–µ—Ä</option>
      </select>
    </label>
    <label class="sound"><input id="soundChk" type="checkbox" checked> –ó–≤—É–∫</label>
  </div>

  <div class="board" role="img" aria-label="–ê–±–∞–∫—É—Å">
    <svg id="svg" viewBox="0 0 1600 600" preserveAspectRatio="xMidYMid meet">
      <defs>
        <!-- –∫–ª–∏–ø, —á—Ç–æ–±—ã —ç–º–æ–¥–∑–∏ –Ω–µ —Ç–æ—Ä—á–∞–ª–∏ –∏–∑ —Ä–∞–º—ã -->
        <clipPath id="inside">
          <rect x="90" y="40" width="1420" height="520" rx="10" ry="10"/>
        </clipPath>
      </defs>
    </svg>
  </div>

  <div class="hint">–¢–∞–ø –ø–æ –±—É—Å–∏–Ω–µ/—ç–º–æ–¥–∑–∏: –≤–µ—Ä—Ö–Ω—è—è —Ç—è–Ω–µ—Ç—Å—è –≤–Ω–∏–∑ –∫ –ø–µ—Ä–µ–∫–ª–∞–¥–∏–Ω–µ (=5), –Ω–∏–∂–Ω–∏–µ ‚Äî –≤–≤–µ—Ä—Ö (=1..4).</div>
</div>

<script>
(function(){
  const svg = document.getElementById('svg');
  const styleSelect = document.getElementById('styleSelect');
  const soundChk = document.getElementById('soundChk');

  // –ì–µ–æ–º–µ—Ç—Ä–∏—è (–ø–æ–¥–æ–≥–Ω–∞–Ω–∞ –ø–æ–¥ ¬´–∫—Ä—É–ø–Ω—ã–π¬ª —Ä–æ–≤–Ω—ã–π –≤–∏–¥)
  const W=1600, H=600;
  const padX=90, padY=40;          // –ø–æ–ª—è —Ä–∞–º–∫–∏
  const sepY=290;                  // –≤—ã—Å–æ—Ç–∞ –ø–µ—Ä–µ–∫–ª–∞–¥–∏–Ω—ã
  const beadRy=36, beadRx=beadRy+10; // –æ–≤–∞–ª—å–Ω–∞—è –±—É—Å–∏–Ω–∞ (–∫–ª–∞—Å—Å–∏–∫–∞)
  const emojiScale=1.62;           // —Ä–∞–∑–º–µ—Ä —ç–º–æ–¥–∑–∏ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –≤—ã—Å–æ—Ç—ã
  const earthGap=84;               // —à–∞–≥ –Ω–∏–∂–Ω–∏—Ö
  const rods=13;

  let cols=[], style='classic';
  try{const s=localStorage.getItem('sorobanStyle'); if(s) style=s;}catch(e){}

  // –ó–≤—É–∫
  let ac=null;
  function clickSound(){
    if(!soundChk.checked) return;
    try{
      if(!ac) ac=new (window.AudioContext||window.webkitAudioContext)();
      const o=ac.createOscillator(), g=ac.createGain();
      o.type='square'; o.frequency.value=880; g.gain.value=0.05;
      o.connect(g); g.connect(ac.destination);
      o.start(); setTimeout(()=>o.stop(),28);
    }catch(e){}
  }

  // SVG helpers
  const NS="http://www.w3.org/2000/svg";
  const $ = n => document.createElementNS(NS,n);
  const rect=(x,y,w,h,cls)=>{const r=$('rect'); r.setAttribute('x',x); r.setAttribute('y',y);
    r.setAttribute('width',w); r.setAttribute('height',h); r.setAttribute('rx',12); r.setAttribute('ry',12);
    r.setAttribute('class',cls); return r;}
  const line=(x1,x2,y1,y2,cls)=>{const l=$('line'); l.setAttribute('x1',x1); l.setAttribute('x2',x2);
    l.setAttribute('y1',y1); l.setAttribute('y2',y2); l.setAttribute('class',cls); return l;}

  function rails(parent){
    parent.appendChild(rect(padX,padY,W-2*padX,26,'rail'));                 // –≤–µ—Ä—Ö
    parent.appendChild(rect(padX,H-padY-26,W-2*padX,26,'rail'));             // –Ω–∏–∑
    parent.appendChild(rect(padX-20,padY,20,H-2*padY,'rail'));               // –ª–µ–≤—ã–π
    parent.appendChild(rect(W-padX,padY,20,H-2*padY,'rail'));                // –ø—Ä–∞–≤—ã–π
    parent.appendChild(rect(padX,sepY-10,W-2*padX,20,'beam'));               // –ø–µ—Ä–µ–∫–ª–∞–¥–∏–Ω–∞
  }

  function makeBead(cx,cy,onTap){
    const g=$('g'); g.setAttribute('class','bead');
    g.addEventListener('click',onTap,false);
    g.addEventListener('touchend',e=>{e.preventDefault();onTap();},false);

    const oval=$('ellipse');
    oval.setAttribute('cx',cx); oval.setAttribute('cy',cy);
    oval.setAttribute('rx',beadRx); oval.setAttribute('ry',beadRy);
    oval.setAttribute('class','oval');

    const txt=$('text');
    txt.setAttribute('x',cx); txt.setAttribute('y',cy+1);
    txt.setAttribute('class','emoji');
    txt.style.fontSize=(beadRy*emojiScale)+'px';
    txt.textContent='üçì';

    g.appendChild(oval); g.appendChild(txt);
    return g;
  }

  function applyStyle(){
    style=styleSelect.value;
    try{localStorage.setItem('sorobanStyle',style);}catch(e){}
    for(const col of cols){
      for(const b of col.beads){
        const g=b.el, oval=g.children[0], txt=g.children[1];
        if(style==='classic'){ oval.style.display='block'; txt.style.display='none'; }
        else { oval.style.display='none'; txt.style.display='block'; txt.textContent=style; }
      }
    }
  }

  function updateCol(col){
    for(const b of col.beads){
      const y=(b.kind==='heaven')?(col.heaven?b.active:b.rest):(col.earth[b.idx]?b.active:b.rest);
      const g=b.el, oval=g.children[0], txt=g.children[1];
      oval.setAttribute('cx',col.cx); oval.setAttribute('cy',y);
      txt.setAttribute('x',col.cx);   txt.setAttribute('y',y+1);
    }
  }

  function init(){
    while(svg.firstChild) svg.removeChild(svg.firstChild);

    // –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —Å–ª–æ–π –ø–æ–¥ –∫–ª–∏–ø, —á—Ç–æ–±—ã –Ω–∏—á–µ–≥–æ –Ω–µ —Ç–æ—Ä—á–∞–ª–æ
    const inner=$('g'); inner.setAttribute('clip-path','url(#inside)'); svg.appendChild(inner);

    // –†–∞–º–∫–∞ –∏ –ø–µ—Ä–µ–∫–ª–∞–¥–∏–Ω–∞
    rails(inner);

    // –°–ø–∏—Ü—ã + –±—É—Å–∏–Ω—ã
    const innerW=W-2*padX, gap=(rods>1)? innerW/(rods-1):0;
    cols=[];
    for(let i=0;i<rods;i++){
      const cx=padX+i*gap;
      inner.appendChild(line(cx,cx,padY+2,H-padY-2,'rod'));

      const col={heaven:0, earth:[0,0,0,0], cx, beads:[]};
      cols.push(col);

      // –≤–µ—Ä—Ö–Ω—è—è
      const hRest=padY+46, hActive=sepY-52;
      const hb=makeBead(cx,hRest,()=>{col.heaven=col.heaven?0:1; clickSound(); updateCol(col);});
      inner.appendChild(hb);
      col.beads.push({el:hb,kind:'heaven',rest:hRest,active:hActive});

      // –Ω–∏–∂–Ω–∏–µ
      for(let j=0;j<4;j++){
        const eRest=sepY+48+j*earthGap, eActive=sepY+22+j*14;
        const eb=makeBead(cx,eRest,()=>{col.earth[j]=col.earth[j]?0:1; clickSound(); updateCol(col);});
        inner.appendChild(eb);
        col.beads.push({el:eb,kind:'earth',idx:j,rest:eRest,active:eActive});
      }
      updateCol(col);
    }

    // –í–µ—Ä—Ö–Ω—è—è —Ä–∞–º–∫–∞ –ø–æ–≤–µ—Ä—Ö ‚Äî –¥–ª—è –∞–∫–∫—É—Ä–∞—Ç–Ω–æ–≥–æ –≤–∏–¥–∞
    rails(svg);

    styleSelect.value=style;
    applyStyle();
  }

  styleSelect.addEventListener('change',applyStyle,false);
  init();
})();
</script>
</body>
</html>

